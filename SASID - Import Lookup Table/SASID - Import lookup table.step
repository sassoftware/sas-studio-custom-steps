{"creationTimeStamp":"2024-12-30T10:11:52.083Z","modifiedTimeStamp":"2024-12-30T15:58:20.014Z","createdBy":"charlie.vismara@sas.com","modifiedBy":"charlie.vismara@sas.com","name":"SASID - Import lookup table.step","displayName":"SASID - Import lookup table.step","localDisplayName":"SASID - Import lookup table.step","properties":{},"links":[{"method":"GET","rel":"self","href":"/dataFlows/steps/5fd43172-0766-43ac-9bc9-b88bb42913f9","uri":"/dataFlows/steps/5fd43172-0766-43ac-9bc9-b88bb42913f9","type":"application/vnd.sas.data.flow.step"},{"method":"GET","rel":"alternate","href":"/dataFlows/steps/5fd43172-0766-43ac-9bc9-b88bb42913f9","uri":"/dataFlows/steps/5fd43172-0766-43ac-9bc9-b88bb42913f9","type":"application/vnd.sas.data.flow.step.summary"},{"method":"GET","rel":"up","href":"/dataFlows/steps","uri":"/dataFlows/steps","type":"application/vnd.sas.collection","itemType":"application/vnd.sas.data.flow.step.summary"},{"method":"PUT","rel":"update","href":"/dataFlows/steps/5fd43172-0766-43ac-9bc9-b88bb42913f9","uri":"/dataFlows/steps/5fd43172-0766-43ac-9bc9-b88bb42913f9","type":"application/vnd.sas.data.flow.step","responseType":"application/vnd.sas.data.flow.step"},{"method":"DELETE","rel":"delete","href":"/dataFlows/steps/5fd43172-0766-43ac-9bc9-b88bb42913f9","uri":"/dataFlows/steps/5fd43172-0766-43ac-9bc9-b88bb42913f9"},{"method":"POST","rel":"copy","href":"/dataFlows/steps/5fd43172-0766-43ac-9bc9-b88bb42913f9/copy","uri":"/dataFlows/steps/5fd43172-0766-43ac-9bc9-b88bb42913f9/copy","responseType":"application/vnd.sas.data.flow.step"},{"method":"GET","rel":"transferExport","href":"/dataFlows/steps/5fd43172-0766-43ac-9bc9-b88bb42913f9","uri":"/dataFlows/steps/5fd43172-0766-43ac-9bc9-b88bb42913f9","responseType":"application/vnd.sas.transfer.object"},{"method":"PUT","rel":"transferImportUpdate","href":"/dataFlows/steps/5fd43172-0766-43ac-9bc9-b88bb42913f9","uri":"/dataFlows/steps/5fd43172-0766-43ac-9bc9-b88bb42913f9","type":"application/vnd.sas.transfer.object","responseType":"application/vnd.sas.summary"}],"metadataVersion":0.0,"version":2,"type":"code","flowMetadata":{"inputPorts":[{"name":"inputtable1","displayName":"inputtable1","localDisplayName":"inputtable1","minEntries":1,"maxEntries":1,"defaultEntries":0,"type":"table"}],"outputPorts":[]},"ui":"{\n\t\"showPageContentOnly\": true,\n\t\"pages\": [\n\t\t{\n\t\t\t\"id\": \"Content\",\n\t\t\t\"type\": \"page\",\n\t\t\t\"label\": \"Data\",\n\t\t\t\"children\": [\n\t\t\t\t{\n\t\t\t\t\t\"id\": \"inputtable1\",\n\t\t\t\t\t\"type\": \"inputtable\",\n\t\t\t\t\t\"label\": \"Input table label 1\",\n\t\t\t\t\t\"required\": true,\n\t\t\t\t\t\"placeholder\": \"\",\n\t\t\t\t\t\"visible\": \"\"\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"id\": \"Columns\",\n\t\t\t\t\t\"type\": \"section\",\n\t\t\t\t\t\"label\": \"Input columns for Keys and Values\",\n\t\t\t\t\t\"open\": true,\n\t\t\t\t\t\"children\": [\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\"id\": \"lookup_keys\",\n\t\t\t\t\t\t\t\"type\": \"columnselector\",\n\t\t\t\t\t\t\t\"label\": \"Keys\",\n\t\t\t\t\t\t\t\"include\": null,\n\t\t\t\t\t\t\t\"order\": false,\n\t\t\t\t\t\t\t\"columntype\": \"a\",\n\t\t\t\t\t\t\t\"max\": 1,\n\t\t\t\t\t\t\t\"min\": 1,\n\t\t\t\t\t\t\t\"visible\": \"\",\n\t\t\t\t\t\t\t\"table\": \"inputtable1\"\n\t\t\t\t\t\t},\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\"id\": \"lookup_values\",\n\t\t\t\t\t\t\t\"type\": \"columnselector\",\n\t\t\t\t\t\t\t\"label\": \"Values\",\n\t\t\t\t\t\t\t\"include\": null,\n\t\t\t\t\t\t\t\"order\": false,\n\t\t\t\t\t\t\t\"columntype\": \"a\",\n\t\t\t\t\t\t\t\"max\": 1,\n\t\t\t\t\t\t\t\"min\": 1,\n\t\t\t\t\t\t\t\"visible\": \"\",\n\t\t\t\t\t\t\t\"table\": \"inputtable1\"\n\t\t\t\t\t\t}\n\t\t\t\t\t]\n\t\t\t\t}\n\t\t\t]\n\t\t},\n\t\t{\n\t\t\t\"id\": \"Metadata\",\n\t\t\t\"type\": \"page\",\n\t\t\t\"label\": \"Metadata\",\n\t\t\t\"children\": [\n\t\t\t\t{\n\t\t\t\t\t\"id\": \"Definition\",\n\t\t\t\t\t\"type\": \"section\",\n\t\t\t\t\t\"label\": \"Definition\",\n\t\t\t\t\t\"open\": true,\n\t\t\t\t\t\"children\": [\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\"id\": \"lookup_nm\",\n\t\t\t\t\t\t\t\"type\": \"textfield\",\n\t\t\t\t\t\t\t\"label\": \"Lookup table name\",\n\t\t\t\t\t\t\t\"placeholder\": \"\",\n\t\t\t\t\t\t\t\"required\": true,\n\t\t\t\t\t\t\t\"visible\": \"\"\n\t\t\t\t\t\t},\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\"id\": \"lookup_desc\",\n\t\t\t\t\t\t\t\"type\": \"textfield\",\n\t\t\t\t\t\t\t\"label\": \"Lookup table description\",\n\t\t\t\t\t\t\t\"placeholder\": \"\",\n\t\t\t\t\t\t\t\"required\": true,\n\t\t\t\t\t\t\t\"visible\": \"\"\n\t\t\t\t\t\t}\n\t\t\t\t\t]\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"id\": \"Location\",\n\t\t\t\t\t\"type\": \"section\",\n\t\t\t\t\t\"label\": \"Location (SAS Content folder)\",\n\t\t\t\t\t\"open\": true,\n\t\t\t\t\t\"children\": [\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\"id\": \"location_type\",\n\t\t\t\t\t\t\t\"type\": \"radiogroup\",\n\t\t\t\t\t\t\t\"label\": \"\",\n\t\t\t\t\t\t\t\"items\": [\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\"value\": \"Browse to location\"\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\"value\": \"Enter location path\"\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t],\n\t\t\t\t\t\t\t\"visible\": \"\"\n\t\t\t\t\t\t},\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\"id\": \"location_browsed\",\n\t\t\t\t\t\t\t\"type\": \"path\",\n\t\t\t\t\t\t\t\"label\": \"Lookup table location\",\n\t\t\t\t\t\t\t\"pathtype\": \"folder\",\n\t\t\t\t\t\t\t\"placeholder\": \"Browse to location\",\n\t\t\t\t\t\t\t\"required\": true,\n\t\t\t\t\t\t\t\"visible\": [\n\t\t\t\t\t\t\t\t\"$location_type\",\n\t\t\t\t\t\t\t\t\"=\",\n\t\t\t\t\t\t\t\t\"Browse to location\"\n\t\t\t\t\t\t\t],\n\t\t\t\t\t\t\t\"indent\": 1,\n\t\t\t\t\t\t\t\"enabled\": [\n\t\t\t\t\t\t\t\t\"$location_type\",\n\t\t\t\t\t\t\t\t\"=\",\n\t\t\t\t\t\t\t\t\"Browse to location\"\n\t\t\t\t\t\t\t]\n\t\t\t\t\t\t},\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\"id\": \"location_string\",\n\t\t\t\t\t\t\t\"type\": \"textfield\",\n\t\t\t\t\t\t\t\"label\": \"Lookup table location\",\n\t\t\t\t\t\t\t\"placeholder\": \"Enter location path (macro allowed)\",\n\t\t\t\t\t\t\t\"required\": true,\n\t\t\t\t\t\t\t\"visible\": [\n\t\t\t\t\t\t\t\t\"$location_type\",\n\t\t\t\t\t\t\t\t\"=\",\n\t\t\t\t\t\t\t\t\"Enter location path\"\n\t\t\t\t\t\t\t],\n\t\t\t\t\t\t\t\"indent\": 1,\n\t\t\t\t\t\t\t\"enabled\": [\n\t\t\t\t\t\t\t\t\"$location_type\",\n\t\t\t\t\t\t\t\t\"=\",\n\t\t\t\t\t\t\t\t\"Enter location path\"\n\t\t\t\t\t\t\t]\n\t\t\t\t\t\t}\n\t\t\t\t\t]\n\t\t\t\t}\n\t\t\t]\n\t\t},\n\t\t{\n\t\t\t\"id\": \"Optional\",\n\t\t\t\"type\": \"page\",\n\t\t\t\"label\": \"Additional Parameters\",\n\t\t\t\"children\": [\n\t\t\t\t{\n\t\t\t\t\t\"id\": \"activate\",\n\t\t\t\t\t\"type\": \"checkbox\",\n\t\t\t\t\t\"label\": \"Activate lookup table after import\",\n\t\t\t\t\t\"visible\": \"\"\n\t\t\t\t}\n\t\t\t]\n\t\t},\n\t\t{\n\t\t\t\"id\": \"About\",\n\t\t\t\"label\": \"About\",\n\t\t\t\"type\": \"page\",\n\t\t\t\"children\": [\n\t\t\t\t{\n\t\t\t\t\t\"id\": \"text1\",\n\t\t\t\t\t\"type\": \"text\",\n\t\t\t\t\t\"text\": \"> Tested on Viya version Stable 2024.12\\n\\n> Requires : SASÂ® Intelligent Decisioning 5.4 or higher\\n\\n> Uses : DCM_IMPORT_LOOKUP macro (https://go.documentation.sas.com/doc/en/edmcdc/5.4/edmmacro/n0ni2e3h31k5x3n1v1w4e46z7rnh.htm)\\n\\n> Uses : <viyahost>/folders/paths REST API (https://developer.sas.com/rest-apis/folders/findByPath)\",\n\t\t\t\t\t\"visible\": \"\"\n\t\t\t\t}\n\t\t\t]\n\t\t}\n\t],\n\t\"syntaxversion\": \"1.3.0\",\n\t\"values\": {\n\t\t\"inputtable1\": {\n\t\t\t\"library\": \"\",\n\t\t\t\"table\": \"\"\n\t\t},\n\t\t\"lookup_keys\": [],\n\t\t\"lookup_values\": [],\n\t\t\"lookup_nm\": \"\",\n\t\t\"lookup_desc\": \"\",\n\t\t\"location_type\": {\n\t\t\t\"value\": \"Browse to location\"\n\t\t},\n\t\t\"location_browsed\": \"\",\n\t\t\"location_string\": \"\",\n\t\t\"activate\": true\n\t}\n}","templates":{"SAS":"/*----------------------------------------------------------------------------------------*\n    This custom step to import and activate (or not) a lookup table for intelligent decisioning from an input table. \n*------------------------------------------------------------------------------------------*/\n\n%macro _import_lkp_table ;\n\n    %put NOTE: ### STEP : SASID - Import lookup table : start ### ;\n    \n    /*----------------------------------------------------------------------------------------*\n        SET lookup table location\n    *------------------------------------------------------------------------------------------*/\n\n        %let lkpdir_rc = 0 ; \n        %let _lookup_folder = ; \n\n        %if &location_type. = Browse to location %then %do ; \n            %let _lookup_folder = &location_browsed. ; \n        %end ;\n        %else %if &location_type. = Enter location path %then %do ; \n            %let _lookup_folder = &location_string. ; \n        %end ; \n\n        %if %sysfunc(kfind(&_lookup_folder., sasserver:))>0 %then %do ; \n            %let lkpdir_rc = 1 ; \n            %put ERROR: # STEP : Invalid lookup table location. Folder must be located on the SAS Content. ;\n        %end;\n        %else %do ;\n\n            %let _lookup_folder = %sysfunc(tranwrd(&_lookup_folder.,sascontent:,)) ;\n\n            %put NOTE: # STEP : Lookup location folder = \"&_lookup_folder\" # ;\n    \n            filename pathinfo temp;\n    \n            data _null_;\n                file pathinfo;\n                folder_path = symget('_lookup_folder') ; \n                if substr(folder_path,1,1) = '/' then do ; \n                    folder_path = substr(folder_path, 2) ; \n                end ; \n                folder_array = '\"'||strip(tranwrd(folder_path, '/', '\",\"'))||'\"' ; \n                json_input = '{\"items\": ['||strip(folder_array)||'], \"contentType\": \"folder\"}';\n                put json_input;\n            run;\n        \n            proc http \n             method='POST' \n             url=\"%sysfunc(getoption(SERVICESBASEURL))/folders/paths\" \n             in=pathinfo \n             oauth_bearer=sas_services \n             ;\n                headers 'Content-Type'='application/vnd.sas.content.folder.path+json';\n            quit;\n    \n        \n            %if &SYS_PROCHTTP_STATUS_CODE. = 404 %then %do;\n                %let lkpdir_rc = 1 ; \n                %put ERROR: # STEP : Invalid lookup table location. Folder not found. ; \n            %end ;\n            %else %if &SYS_PROCHTTP_STATUS_CODE. ne 200 %then %do;\n                %let lkpdir_rc = 1 ; \n                %put ERROR: # STEP : Invalid lookup table location. Bad Request. ; \n            %end ;\n    \n            filename pathinfo clear ; \n\n        %end ; \n\n    /*----------------------------------------------------------------------------------------*\n        Create lookup CSV\n    *------------------------------------------------------------------------------------------*/\n\n        %let lkp_rc = 1 ;\n    \n        filename lkp_csv temp ;\n        \n        proc sql noprint ; \n            create table lookup as \n            select distinct\n                \"&lookup_nm.\" as LOOKUP_NM, \n                \"&lookup_desc.\" as DESCRIPTION, \n                \"&_lookup_folder\" as FOLDER_PATH, \n                &lookup_keys as NAME, \n                &lookup_values as VALUE, \n                \"\" as DISABLED, \n                \"\" as ENTITY_SQ_NO, \n                \"lookup\" as TYPE_NM\n            from &inputtable1. ;\n        run ;\n        quit ; \n\n        proc export data=lookup \n                    outfile=lkp_csv\n                    dbms=csv replace;\n        run ; \n\n        %put NOTE: # STEP : CSV lookup fileref = \"lkp_csv\" # ; \n\n        %put NOTE: # STEP : CSV lookup file path = \"%sysfunc(pathname(lkp_csv))\" # ; \n\n        data _null_ ; \n            fid = fopen(\"lkp_csv\", \"i\") ; \n            if fid <= 0 then do ; \n                m=sysmsg(); \n                put m; \n                put \"ERROR: # STEP : Invalid lookup CSV file. File could not be opened.\" ; \n            end ;  \n            else do ; \n                rc = fclose(fid) ; \n                call symputx('lkp_rc', \"0\") ; \n            end ; \n        run ; \n    \n    /*----------------------------------------------------------------------------------------*\n        Activate Lookup table?\n    *------------------------------------------------------------------------------------------*/\n\n        %let _active = NO; \n        %if &activate. = 1 %then %let _active = YES ; \n    \n        %put NOTE: # STEP : ACTIVE = \"&_active\" # ;\n\n    /*----------------------------------------------------------------------------------------*\n        Create SAS ID LOOKUP table : DCM_IMPORT_LOOKUP. \n        https://go.documentation.sas.com/doc/en/edmcdc/5.4/edmmacro/n0ni2e3h31k5x3n1v1w4e46z7rnh.htm\n    *------------------------------------------------------------------------------------------*/\n\n        %put NOTE: # STEP : Parameters validation --> All rc parameters must return 0 for the import to be executed. ;\n        %put NOTE: # STEP : Parameters validation (1) : Lookup table location rc = &lkpdir_rc ; \n        %put NOTE: # STEP : Parameters validation (2) : Lookup file rc = &lkp_rc ; \n\n        %if %eval (&lkpdir_rc. + &lkp_rc.) = 0 %then %do ; \n            %put NOTE: # STEP : Import lookup macro \"DCM_IMPORT_LOOKUP\" starting... # ;\n                %DCM_IMPORT_LOOKUP (CSV=lkp_csv, ACTIVE=&_active.) ;\n            %put NOTE: # STEP : Import lookup macro \"DCM_IMPORT_LOOKUP\" completed. # ;\n        %end ; \n        %else %do ; \n            %put ERROR: # STEP : At least one rc parameter is not valid. Import lookup Cancelled. # ; \n        %end ; \n    \n        filename lkp_csv clear ; \n    \n    %put NOTE: ### STEP : SASID - Import lookup table : end ### ;\n\n%mend _import_lkp_table ; \n\n%_import_lkp_table ; \n"}}