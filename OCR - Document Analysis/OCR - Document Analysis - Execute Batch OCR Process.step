{"creationTimeStamp":"2024-09-19T17:21:17.024Z","modifiedTimeStamp":"2024-10-03T13:58:36.433Z","createdBy":"sasdemo","modifiedBy":"sasdemo","name":"Execute SDA Batch.step","displayName":"Execute SDA Batch.step","localDisplayName":"Execute SDA Batch.step","properties":{},"links":[{"method":"GET","rel":"self","href":"/dataFlows/steps/8e28f862-d4a0-4d1d-82d0-9882d0589139","uri":"/dataFlows/steps/8e28f862-d4a0-4d1d-82d0-9882d0589139","type":"application/vnd.sas.data.flow.step"},{"method":"GET","rel":"alternate","href":"/dataFlows/steps/8e28f862-d4a0-4d1d-82d0-9882d0589139","uri":"/dataFlows/steps/8e28f862-d4a0-4d1d-82d0-9882d0589139","type":"application/vnd.sas.data.flow.step.summary"},{"method":"GET","rel":"up","href":"/dataFlows/steps","uri":"/dataFlows/steps","type":"application/vnd.sas.collection","itemType":"application/vnd.sas.data.flow.step.summary"},{"method":"PUT","rel":"update","href":"/dataFlows/steps/8e28f862-d4a0-4d1d-82d0-9882d0589139","uri":"/dataFlows/steps/8e28f862-d4a0-4d1d-82d0-9882d0589139","type":"application/vnd.sas.data.flow.step","responseType":"application/vnd.sas.data.flow.step"},{"method":"DELETE","rel":"delete","href":"/dataFlows/steps/8e28f862-d4a0-4d1d-82d0-9882d0589139","uri":"/dataFlows/steps/8e28f862-d4a0-4d1d-82d0-9882d0589139"},{"method":"POST","rel":"copy","href":"/dataFlows/steps/8e28f862-d4a0-4d1d-82d0-9882d0589139/copy","uri":"/dataFlows/steps/8e28f862-d4a0-4d1d-82d0-9882d0589139/copy","responseType":"application/vnd.sas.data.flow.step"},{"method":"GET","rel":"transferExport","href":"/dataFlows/steps/8e28f862-d4a0-4d1d-82d0-9882d0589139","uri":"/dataFlows/steps/8e28f862-d4a0-4d1d-82d0-9882d0589139","responseType":"application/vnd.sas.transfer.object"},{"method":"PUT","rel":"transferImportUpdate","href":"/dataFlows/steps/8e28f862-d4a0-4d1d-82d0-9882d0589139","uri":"/dataFlows/steps/8e28f862-d4a0-4d1d-82d0-9882d0589139","type":"application/vnd.sas.transfer.object","responseType":"application/vnd.sas.summary"}],"metadataVersion":0.0,"version":2,"type":"code","flowMetadata":{"inputPorts":[],"outputPorts":[]},"ui":"{\n\t\"showPageContentOnly\": true,\n\t\"pages\": [\n\t\t{\n\t\t\t\"id\": \"page1\",\n\t\t\t\"type\": \"page\",\n\t\t\t\"label\": \"Page 1\",\n\t\t\t\"children\": [\n\t\t\t\t{\n\t\t\t\t\t\"id\": \"Header\",\n\t\t\t\t\t\"type\": \"text\",\n\t\t\t\t\t\"text\": \"SAS Studio Custom Step for executing the SAS Document Analysis OCR batch process. At a minimum, users must specify a folder containing files to be processed, the OCR engine to use, the SAS Launcher Context ID to execute against, and the logging level.\\n\\nFor more details, please reference the official documentation.\",\n\t\t\t\t\t\"visible\": \"\"\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"id\": \"SOURCE_DATA_DIRECTORY\",\n\t\t\t\t\t\"type\": \"path\",\n\t\t\t\t\t\"label\": \"Select Directory Containing Source Files to Process\",\n\t\t\t\t\t\"pathtype\": \"folder\",\n\t\t\t\t\t\"placeholder\": \"Select Directory Containing Source Files to Process\",\n\t\t\t\t\t\"required\": true,\n\t\t\t\t\t\"visible\": \"\"\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"id\": \"OCR_ENGINE\",\n\t\t\t\t\t\"type\": \"dropdown\",\n\t\t\t\t\t\"label\": \"Cloud OCR Engine\",\n\t\t\t\t\t\"items\": [\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\"value\": \"ms\",\n\t\t\t\t\t\t\t\"label\": \"Microsoft OCR\"\n\t\t\t\t\t\t},\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\"value\": \"aws\",\n\t\t\t\t\t\t\t\"label\": \"AWS Textract\"\n\t\t\t\t\t\t},\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\"value\": \"mock\",\n\t\t\t\t\t\t\t\"label\": \"Mock (For Testing)\"\n\t\t\t\t\t\t}\n\t\t\t\t\t],\n\t\t\t\t\t\"required\": true,\n\t\t\t\t\t\"placeholder\": \"Select Cloud OCR Engine\",\n\t\t\t\t\t\"visible\": \"\"\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"id\": \"LAUNCHER_CONTEXT_ID\",\n\t\t\t\t\t\"type\": \"textfield\",\n\t\t\t\t\t\"label\": \"SAS launcher Context ID\",\n\t\t\t\t\t\"placeholder\": \"ex. b7be2e5f-a65a-4659-8e4e-84d833b2bcc5\",\n\t\t\t\t\t\"required\": true,\n\t\t\t\t\t\"visible\": \"\"\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"id\": \"LOG_LEVEL\",\n\t\t\t\t\t\"type\": \"dropdown\",\n\t\t\t\t\t\"label\": \"Logging Level\",\n\t\t\t\t\t\"items\": [\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\"value\": \"INFO\"\n\t\t\t\t\t\t},\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\"value\": \"WARNING\"\n\t\t\t\t\t\t},\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\"value\": \"ERROR\"\n\t\t\t\t\t\t},\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\"value\": \"CRITICAL\"\n\t\t\t\t\t\t},\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\"value\": \"DEBUG\"\n\t\t\t\t\t\t}\n\t\t\t\t\t],\n\t\t\t\t\t\"required\": true,\n\t\t\t\t\t\"placeholder\": \"\",\n\t\t\t\t\t\"visible\": \"\"\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"id\": \"BATCH_TAG\",\n\t\t\t\t\t\"type\": \"textfield\",\n\t\t\t\t\t\"label\": \"Optional Batch Tag Identifier\",\n\t\t\t\t\t\"placeholder\": \"ex. Batch_123ABC\",\n\t\t\t\t\t\"required\": false,\n\t\t\t\t\t\"visible\": \"\"\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"id\": \"SKIP_RE_OCR\",\n\t\t\t\t\t\"type\": \"radiogroup\",\n\t\t\t\t\t\"label\": \"Avoid Duplicate OCR Calls\",\n\t\t\t\t\t\"items\": [\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\"value\": \"True\"\n\t\t\t\t\t\t},\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\"value\": \"False\"\n\t\t\t\t\t\t}\n\t\t\t\t\t],\n\t\t\t\t\t\"visible\": \"\"\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"id\": \"USE_UUID_AS_NAME\",\n\t\t\t\t\t\"type\": \"radiogroup\",\n\t\t\t\t\t\"label\": \"Assign UUID to File Names\",\n\t\t\t\t\t\"items\": [\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\"value\": \"True\"\n\t\t\t\t\t\t},\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\"value\": \"False\"\n\t\t\t\t\t\t}\n\t\t\t\t\t],\n\t\t\t\t\t\"visible\": \"\"\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"id\": \"DELETE_SOURCE_FILES\",\n\t\t\t\t\t\"type\": \"radiogroup\",\n\t\t\t\t\t\"label\": \"Remove Source Files\",\n\t\t\t\t\t\"items\": [\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\"value\": \"True\"\n\t\t\t\t\t\t},\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\"value\": \"False\"\n\t\t\t\t\t\t}\n\t\t\t\t\t],\n\t\t\t\t\t\"visible\": \"\"\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"id\": \"KEEP_SUBDIRECTORIES\",\n\t\t\t\t\t\"type\": \"radiogroup\",\n\t\t\t\t\t\"label\": \"Maintain Source Directory Structure\",\n\t\t\t\t\t\"items\": [\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\"value\": \"True\"\n\t\t\t\t\t\t},\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\"value\": \"False\"\n\t\t\t\t\t\t}\n\t\t\t\t\t],\n\t\t\t\t\t\"visible\": \"\"\n\t\t\t\t}\n\t\t\t]\n\t\t}\n\t],\n\t\"syntaxversion\": \"1.3.0\",\n\t\"values\": {\n\t\t\"SOURCE_DATA_DIRECTORY\": \"\",\n\t\t\"OCR_ENGINE\": null,\n\t\t\"LAUNCHER_CONTEXT_ID\": \"\",\n\t\t\"LOG_LEVEL\": {\n\t\t\t\"value\": \"INFO\"\n\t\t},\n\t\t\"BATCH_TAG\": \"\",\n\t\t\"SKIP_RE_OCR\": {\n\t\t\t\"value\": \"True\"\n\t\t},\n\t\t\"USE_UUID_AS_NAME\": {\n\t\t\t\"value\": \"True\"\n\t\t},\n\t\t\"DELETE_SOURCE_FILES\": {\n\t\t\t\"value\": \"False\"\n\t\t},\n\t\t\"KEEP_SUBDIRECTORIES\": {\n\t\t\t\"value\": \"True\"\n\t\t}\n\t}\n}","templates":{"SAS":"/*Create a temporary file*/\nfilename outResp temp; \n\n/*Get the Viya Host URL*/\n%let viyaHost=%sysfunc(getoption(SERVICESBASEURL));\n\n%if \"&SKIP_RE_OCR\"=\"True\" %then %do;\n\t%let FORCE_OCR=False;\n%end;\n%if \"&SKIP_RE_OCR\"=\"False\" %then %do;\n\t%let FORCE_OCR=True;\n%end;\n\n/*Folder from task template comes prefixed with sascontent: or sasserver: -- disregard this portion*/\n%let SOURCE_DATA_DIRECTORY= %scan(&SOURCE_DATA_DIRECTORY.,2,:);\n\n%let HTTP_REQUEST_BODY=%str({ \"name\":\"sda-batch-ocr-process\",\n          \"description\":\"Execute OCR Process Using SAS Document Analysis\",\n           \"command\":\"python process/sda-ocr/scripts/run_sda_batch.py\",\n           \"contextId\":\"%superq(LAUNCHER_CONTEXT_ID)\",\n           \"environment\":{\n                \"SOURCE_DATA_DIRECTORY\":\"%superq(SOURCE_DATA_DIRECTORY)\",\n                \"OCR_ENGINE\":\"%superq(OCR_ENGINE)\",\n                \"SKIP_RE_OCR\": \"%superq(SKIP_RE_OCR)\",\n                \"FORCE_OCR\": \"%superq(FORCE_OCR)\",\n                \"LOG_LEVEL\": \"%superq(LOG_LEVEL)\",\n                \"USE_UUID_AS_NAME\": \"%superq(USE_UUID_AS_NAME)\",\n                \"DELETE_SOURCE_FILES\": \"%superq(DELETE_SOURCE_FILES)\",\n                \"KEEP_SUBDIRECTORIES\": \"%superq(KEEP_SUBDIRECTORIES)\",\n                \"BATCH_TAG\": \"%superq(BATCH_TAG)\"\n            }, \n           \"kubernetes\": {\"jobNamePrefix\": \"sda-execute-ocr-\"} \n     });\n\n/*Proc HTTP Request*/\nproc http method='POST' \n    url=\"&viyaHost./launcher/processes\" \n    in=%tslit(&HTTP_REQUEST_BODY)\n    oauth_bearer=sas_services out=outResp; \n    debug level=1; \n    headers 'Accept'=' application/vnd.sas.launcher.process+json'; \n    headers 'Content-Type'=' application/json';\nrun;\n\n/*HTTP Status Handling*/\ndata _null_; \n    if &SYS_PROCHTTP_STATUS_CODE. lt 400 then do; \n        put \"NOTE: The request to launch the SDA process was successful.\"; \n        put \"NOTE: The HTTP Status Code is &SYS_PROCHTTP_STATUS_CODE..\"; \n        put \"NOTE: That means: &SYS_PROCHTTP_STATUS_PHRASE..\"; \n    end; \n    else do; \n        put \"ERROR: The request to launch the SDA process was most likely not successful.\"; \n        put \"ERROR: The HTTP Status Code is &SYS_PROCHTTP_STATUS_CODE..\"; \n        put \"ERROR: That means: &SYS_PROCHTTP_STATUS_PHRASE..\"; \n    end; \nrun;\n\nlibname resp json fileref=outResp;\n\n%let OUTPUT_DIRECTORY = \"\";\n%let PROCESS = \"\";\ndata _null_;\nset resp.alldata;\nif upcase(P1)=\"ENVIRONMENT\" then do;\n\tif upcase(P2)=\"OUTPUT_DIRECTORY\" then call symput(\"OUTPUT_DIRECTORY\",cats(value));\n\tif upcase(P2)=\"PROCESS\" then call symput(\"PROCESS\",cats(value));\nend;\nrun;\n\ndata message_output;\n    length message $300;\n    if \"&OUTPUT_DIRECTORY.\" ne \"\" and \"&PROCESS.\" ne \"\" then do;\n        message = \"Logs have been routed to \" || \"&OUTPUT_DIRECTORY./&PROCESS./logs\";\n        output;\n        message = \"Output data has been routed to \" || \"&OUTPUT_DIRECTORY./&PROCESS./data\";\n        output;\n    end;\n\telse do;\n        message = \"Data and logs have been routed to the default location specified during installation\";\n        output;\n\tend;\nrun;\n\nproc print data=message_output noobs;\n    var message;\nrun;\n\nproc sql;\n\tdrop table message_output;\nquit;"}}