{"type":"code","name":"OCR - Document Analysis - Execute Batch OCR Process.step","displayName":"OCR - Document Analysis - Execute Batch OCR Process.step","description":"The OCR - Document Analysis - Execute Batch OCR Process custom steps enables an easy integration with the SAS Document Analysis (SDA) model, to run a full batch job, without the need to write any code.","templates":{"SAS":"* _sda_ is short for Execute SDA Batch, where SDA stands for SAS Document Analysis;\ndata _null_;\n    * Check that the user provided a valid ID for the launcher context;\n    if not prxMatch('/^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i', \"&_sda_launcher_context_id.\") then do;\n        putLog 'ERROR: The provided launcher context ID is not valid.';\n        abort 40;\n    end;\n\n    * Check that the user provided a source directory on the SAS server and not in SAS Content;\n    mode = scan(\"&_sda_source_data_directory.\", 1, ':', 'MO');\n    if mode EQ 'sasserver' then do;\n        call symputx('_sda_src_dirpath', scan(\"&_sda_source_data_directory.\", 2, ':', 'MO'));\n    end;\n    else do;\n        putLog 'ERROR: Please ensure that the selected source directory is on the SAS server.';\n        abort 50;\n    end;\nrun;\n\n* Get the Viya Host URL;\n%let _sda_viyaHost=%sysfunc(getoption(SERVICESBASEURL));\n\n/* Preprocess macrovars to convert binary to boolean */\n%if &_sda_skip_re_ocr. %then %do;\n\t%let _sda_skip_re_ocr = True;\n\t%let _sda_force_ocr = False;\n%end;\n%else %do;\n\t%let _sda_skip_re_ocr = False;\n\t%let _sda_force_ocr = True;\n%end;\t\n\n%if &_sda_use_uuid_as_name. %then %do; %let _sda_use_uuid_as_name=True; %end;\n%else %do; %let _sda_use_uuid_as_name = False; %end;\n\n%if &_sda_delete_source_files. %then %do; %let _sda_delete_source_files=True; %end;\n%else %do; %let _sda_delete_source_files = False; %end;\n\n%if &_sda_keep_subdirectories. %then %do; %let _sda_keep_subdirectories=True; %end;\n%else %do; %let _sda_keep_subdirectories=False; %end;\n\n/* Construct HTTP reuqest body */\n%let _SDA_HTTP_REQUEST_BODY=%str({ \"name\":\"sda-batch-ocr-process\",\n          \"description\":\"Execute OCR Process Using SAS Document Analysis\",\n           \"command\":\"python process/sda-ocr/scripts/run_sda_batch.py\",\n           \"contextId\":\"%superq(_sda_launcher_context_id)\",\n           \"environment\":{\n                \"SOURCE_DATA_DIRECTORY\":\"%superq(_sda_src_dirpath)\",\n                \"OCR_ENGINE\":\"%superq(_sda_ocr_engine)\",\n                \"SKIP_RE_OCR\": \"%superq(_sda_skip_re_ocr)\",\n                \"FORCE_OCR\": \"%superq(_sda_force_ocr)\",\n                \"LOG_LEVEL\": \"%superq(_sda_log_level)\",\n                \"USE_UUID_AS_NAME\": \"%superq(_sda_use_uuid_as_name)\",\n                \"DELETE_SOURCE_FILES\": \"%superq(_sda_delete_source_files)\",\n                \"KEEP_SUBDIRECTORIES\": \"%superq(_sda_keep_subdirectories)\",\n                \"BATCH_TAG\": \"%superq(_sda_batch_tag)\"\n            }, \n           \"kubernetes\": {\"jobNamePrefix\": \"sda-execute-ocr-\"} \n     });\n\n%put &=_SDA_HTTP_REQUEST_BODY;\n\nfilename _sda_out temp; \n\n* Start a SAS launcher process, which will in turn run the SDA process;\nproc http\n    method='POST' \n    url = \"&_sda_viyaHost./launcher/processes\" \n    in = %tslit(&_SDA_HTTP_REQUEST_BODY)\n    oauth_bearer = sas_services\n    out = _sda_out; \n    headers 'Accept' = 'application/vnd.sas.launcher.process+json'; \n    headers 'Content-Type' = 'application/json';\nrun;\n\n* HTTP Status Handling;\ndata _null_; \n    if &SYS_PROCHTTP_STATUS_CODE. lt 400 then do; \n        put 'NOTE: The request to launch the SDA process was successful.'; \n        put \"NOTE: The HTTP Status Code is &SYS_PROCHTTP_STATUS_CODE..\"; \n        put \"NOTE: That means: &SYS_PROCHTTP_STATUS_PHRASE..\"; \n    end; \n    else do; \n        put 'ERROR: The request to launch the SDA process was most likely not successful.'; \n        put \"ERROR: The HTTP Status Code is &SYS_PROCHTTP_STATUS_CODE..\"; \n        put \"ERROR: That means: &SYS_PROCHTTP_STATUS_PHRASE..\"; \n    end; \nrun;\n\n/* give process time to execute */\ndata _null_;\n   call sleep(5, 1);\nrun;\n/* TODO: replace with async polling */\n\nlibname _sda_out json;\n%let _sda_process = '';\n%let _sda_output_directory = '';\n\n* Check if a output directory that differs from the default was provided;\ndata _null_;\n    set _sda_out.alldata;\n    if upcase(P1)='ENVIRONMENT' then do;\n        if upcase(P2)='OUTPUT_DIRECTORY' then call symput('_sda_output_directory', cats(value));\n        if upcase(P2)='PROCESS' then call symput('_sda_process', cats(value));\n    end;\nrun;\n\n* Inform the user about the out comes of the run;\ndata work._sda_message_output;\n    length message $500;\n\n    if \"&_sda_output_directory.\" ne '' and \"&_sda_process.\" ne '' then do;\n        message = 'Logs have been routed to ' || \"&_sda_output_directory./&_sda_process./logs\";\n        output;\n        message = 'Output data has been routed to ' || \"&_sda_output_directory./&_sda_process./data\";\n        output;\n    end;\n    else do;\n        message = 'Data and logs have been routed to the default location specified during installation';\n        output;\n    end;\nrun;\n\n* Print the information for the user;\nproc print data=work._sda_message_output noObs;\n    var message;\nrun;\n\n\n* Clean up;\nlibname _sda_out clear;\nfilename _sda_out clear;\n%symdel _sda_viyaHost _sda_output_directory _sda_process;\nproc datasets library=work noList;\n    delete _sda_message_output;\nrun; quit;"},"properties":{},"ui":"{\n\t\"showPageContentOnly\": true,\n\t\"pages\": [\n\t\t{\n\t\t\t\"id\": \"pageOptions\",\n\t\t\t\"type\": \"page\",\n\t\t\t\"label\": \"Options\",\n\t\t\t\"children\": [\n\t\t\t\t{\n\t\t\t\t\t\"id\": \"_esb_source_data_directory_txt\",\n\t\t\t\t\t\"type\": \"text\",\n\t\t\t\t\t\"text\": \"SAS Studio Custom Step for executing the SAS Document Analysis OCR batch process. At a minimum, users must specify a folder containing files to be processed, the OCR engine to use and the SAS launcher context ID to execute against.\\n\\nThe source directory should contain files of the following types in order to be processed and should be located on the server file sysem (not in SAS Content): [PDF, PNG, JPG, JPEG, TIF, TIFF, BMP, ZIP]\",\n\t\t\t\t\t\"visible\": \"\"\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"id\": \"_sda_source_data_directory\",\n\t\t\t\t\t\"type\": \"path\",\n\t\t\t\t\t\"label\": \"Select directory containing source files to process:\",\n\t\t\t\t\t\"pathtype\": \"folder\",\n\t\t\t\t\t\"placeholder\": \"Select directory containing source files to process\",\n\t\t\t\t\t\"required\": true,\n\t\t\t\t\t\"visible\": \"\"\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"id\": \"_sda_ocr_engine\",\n\t\t\t\t\t\"type\": \"dropdown\",\n\t\t\t\t\t\"label\": \"Select cloud OCR engine:\",\n\t\t\t\t\t\"items\": [\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\"value\": \"ms\",\n\t\t\t\t\t\t\t\"label\": \"Microsoft OCR\"\n\t\t\t\t\t\t},\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\"value\": \"aws\",\n\t\t\t\t\t\t\t\"label\": \"AWS Textract\"\n\t\t\t\t\t\t}\n\t\t\t\t\t],\n\t\t\t\t\t\"required\": true,\n\t\t\t\t\t\"placeholder\": \"Select cloud OCR engine\",\n\t\t\t\t\t\"visible\": \"\"\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"id\": \"_sda_launcher_context_id\",\n\t\t\t\t\t\"type\": \"textfield\",\n\t\t\t\t\t\"label\": \"Enter SAS launcher context ID:\",\n\t\t\t\t\t\"placeholder\": \"ex. b7be2e5f-a65a-4659-8e4e-84d833b2bcc5\",\n\t\t\t\t\t\"required\": true,\n\t\t\t\t\t\"visible\": \"\"\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"id\": \"_esb_launcher_context_id_txt\",\n\t\t\t\t\t\"type\": \"text\",\n\t\t\t\t\t\"text\": \"To get the SAS launcher context ID for the SDA launcher context please speak with your SAS Viya administrator that deployed SDA in your environment.\",\n\t\t\t\t\t\"visible\": \"\"\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"id\": \"_sda_log_level\",\n\t\t\t\t\t\"type\": \"dropdown\",\n\t\t\t\t\t\"label\": \"Select logging level:\",\n\t\t\t\t\t\"items\": [\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\"value\": \"INFO\",\n\t\t\t\t\t\t\t\"label\": \"Info\"\n\t\t\t\t\t\t},\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\"value\": \"WARNING\",\n\t\t\t\t\t\t\t\"label\": \"Warning\"\n\t\t\t\t\t\t},\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\"value\": \"ERROR\",\n\t\t\t\t\t\t\t\"label\": \"Error\"\n\t\t\t\t\t\t},\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\"value\": \"CRITICAL\",\n\t\t\t\t\t\t\t\"label\": \"Critical\"\n\t\t\t\t\t\t},\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\"value\": \"DEBUG\",\n\t\t\t\t\t\t\t\"label\": \"Debug\"\n\t\t\t\t\t\t}\n\t\t\t\t\t],\n\t\t\t\t\t\"required\": true,\n\t\t\t\t\t\"placeholder\": \"\",\n\t\t\t\t\t\"visible\": \"\"\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"id\": \"_sda_batch_tag\",\n\t\t\t\t\t\"type\": \"textfield\",\n\t\t\t\t\t\"label\": \"Provide an optional batch tag identifier:\",\n\t\t\t\t\t\"placeholder\": \"ex. Batch_123ABC\",\n\t\t\t\t\t\"required\": false,\n\t\t\t\t\t\"visible\": \"\"\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"id\": \"_esb_batch_tag_txt\",\n\t\t\t\t\t\"type\": \"text\",\n\t\t\t\t\t\"text\": \"The optional batch tag identifier allows users to group files by a common label.\",\n\t\t\t\t\t\"visible\": \"\"\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"id\": \"_sda_skip_re_ocr\",\n\t\t\t\t\t\"type\": \"checkbox\",\n\t\t\t\t\t\"label\": \"Avoid duplicate OCR calls\",\n\t\t\t\t\t\"visible\": \"\"\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"id\": \"_sda_use_uuid_as_name\",\n\t\t\t\t\t\"type\": \"checkbox\",\n\t\t\t\t\t\"label\": \"Assign UUID to file names\",\n\t\t\t\t\t\"visible\": \"\"\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"id\": \"_sda_keep_subdirectories\",\n\t\t\t\t\t\"type\": \"checkbox\",\n\t\t\t\t\t\"label\": \"Maintain source directory structure\",\n\t\t\t\t\t\"visible\": \"\"\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"id\": \"_sda_delete_source_files\",\n\t\t\t\t\t\"type\": \"checkbox\",\n\t\t\t\t\t\"label\": \"Remove source files\",\n\t\t\t\t\t\"visible\": \"\"\n\t\t\t\t}\n\t\t\t]\n\t\t},\n\t\t{\n\t\t\t\"id\": \"pageAbout\",\n\t\t\t\"type\": \"page\",\n\t\t\t\"label\": \"About\",\n\t\t\t\"children\": [\n\t\t\t\t{\n\t\t\t\t\t\"id\": \"textAbout\",\n\t\t\t\t\t\"type\": \"text\",\n\t\t\t\t\t\"text\": \"OCR - Document Analysis - Execute Batch OCR Process step\\n==========\\n\\nThe \\\"OCR - Document Analysis - Execute Batch OCR Process\\\" custom steps enables an easy integration with the SAS Document Analysis (SDA) model, to run a full batch job, without the need to write any code.\\n\\nThe following cloud OCR engines are supported: \\n  * Microsoft OCR\\n  * AWS Textract\\n\\nThe location of the generated output will be displayed for after running this step.\\n\",\n\t\t\t\t\t\"visible\": \"\"\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"id\": \"sectionPrereqs\",\n\t\t\t\t\t\"type\": \"section\",\n\t\t\t\t\t\"label\": \"Pre-requisites\",\n\t\t\t\t\t\"open\": false,\n\t\t\t\t\t\"visible\": \"\",\n\t\t\t\t\t\"children\": [\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\"id\": \"textPrereqs\",\n\t\t\t\t\t\t\t\"type\": \"text\",\n\t\t\t\t\t\t\t\"text\": \"A license for SAS Document Analysis (SDA) is required and you will need to know the ID of the launch context that was created during the deployment of SDA.\\n\\nPre-requisites:  Tested on Viya version Stable 2024.08\",\n\t\t\t\t\t\t\t\"visible\": \"\"\n\t\t\t\t\t\t}\n\t\t\t\t\t]\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"id\": \"sectionDocumentation\",\n\t\t\t\t\t\"type\": \"section\",\n\t\t\t\t\t\"label\": \"Documentation\",\n\t\t\t\t\t\"open\": false,\n\t\t\t\t\t\"visible\": \"\",\n\t\t\t\t\t\"children\": [\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\"id\": \"textDocumentation\",\n\t\t\t\t\t\t\t\"type\": \"text\",\n\t\t\t\t\t\t\t\"text\": \"* SAS Document Analysis documentation (https://go.documentation.sas.com/doc/en/aaimdacdc/default/aaimdawlcm/home.htm)\",\n\t\t\t\t\t\t\t\"visible\": \"\"\n\t\t\t\t\t\t}\n\t\t\t\t\t]\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"id\": \"sectionChangelog\",\n\t\t\t\t\t\"type\": \"section\",\n\t\t\t\t\t\"label\": \"Changelog\",\n\t\t\t\t\t\"open\": true,\n\t\t\t\t\t\"visible\": \"\",\n\t\t\t\t\t\"children\": [\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\"id\": \"textChangelog\",\n\t\t\t\t\t\t\t\"type\": \"text\",\n\t\t\t\t\t\t\t\"text\": \"* Version 1.1 (09OCT2024)\\n     - Implemented feedback\\n\\n* Version: 1.0 (07OCT2024)\\n      - Initial version\",\n\t\t\t\t\t\t\t\"visible\": \"\"\n\t\t\t\t\t\t}\n\t\t\t\t\t]\n\t\t\t\t}\n\t\t\t]\n\t\t}\n\t],\n\t\"syntaxversion\": \"1.3.0\",\n\t\"values\": {\n\t\t\"_sda_source_data_directory\": \"\",\n\t\t\"_sda_ocr_engine\": null,\n\t\t\"_sda_launcher_context_id\": \"\",\n\t\t\"_sda_log_level\": {\n\t\t\t\"value\": \"INFO\",\n\t\t\t\"label\": \"Info\"\n\t\t},\n\t\t\"_sda_batch_tag\": \"\",\n\t\t\"_sda_skip_re_ocr\": true,\n\t\t\"_sda_use_uuid_as_name\": true,\n\t\t\"_sda_keep_subdirectories\": true,\n\t\t\"_sda_delete_source_files\": false\n\t}\n}","flowMetadata":{"inputPorts":[],"outputPorts":[]}}