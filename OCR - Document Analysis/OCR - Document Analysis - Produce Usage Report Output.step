{"creationTimeStamp":"2025-02-25T19:18:48.47306Z","createdBy":"sasdemo","modifiedTimeStamp":"2026-02-19T20:40:21.731963Z","modifiedBy":"sasdemo","id":"e05fb503-d516-4f2a-974a-f596ea04f29b","name":"OCR - Document Analysis - Produce Usage Report Output.step","displayName":"OCR - Document Analysis - Produce Usage Report Output.step","localDisplayName":"OCR - Document Analysis - Produce Usage Report Output.step","links":[{"method":"GET","rel":"self","href":"/dataFlows/steps/e05fb503-d516-4f2a-974a-f596ea04f29b","uri":"/dataFlows/steps/e05fb503-d516-4f2a-974a-f596ea04f29b","type":"application/vnd.sas.data.flow.step"},{"method":"GET","rel":"alternate","href":"/dataFlows/steps/e05fb503-d516-4f2a-974a-f596ea04f29b","uri":"/dataFlows/steps/e05fb503-d516-4f2a-974a-f596ea04f29b","type":"application/vnd.sas.data.flow.step.summary"},{"method":"GET","rel":"up","href":"/dataFlows/steps","uri":"/dataFlows/steps","type":"application/vnd.sas.collection","itemType":"application/vnd.sas.data.flow.step.summary"},{"method":"PUT","rel":"update","href":"/dataFlows/steps/e05fb503-d516-4f2a-974a-f596ea04f29b","uri":"/dataFlows/steps/e05fb503-d516-4f2a-974a-f596ea04f29b","type":"application/vnd.sas.data.flow.step","responseType":"application/vnd.sas.data.flow.step"},{"method":"DELETE","rel":"delete","href":"/dataFlows/steps/e05fb503-d516-4f2a-974a-f596ea04f29b","uri":"/dataFlows/steps/e05fb503-d516-4f2a-974a-f596ea04f29b"},{"method":"POST","rel":"copy","href":"/dataFlows/steps/e05fb503-d516-4f2a-974a-f596ea04f29b/copy","uri":"/dataFlows/steps/e05fb503-d516-4f2a-974a-f596ea04f29b/copy","responseType":"application/vnd.sas.data.flow.step"},{"method":"GET","rel":"transferExport","href":"/dataFlows/steps/e05fb503-d516-4f2a-974a-f596ea04f29b","uri":"/dataFlows/steps/e05fb503-d516-4f2a-974a-f596ea04f29b","responseType":"application/vnd.sas.transfer.object"},{"method":"PUT","rel":"transferImportUpdate","href":"/dataFlows/steps/e05fb503-d516-4f2a-974a-f596ea04f29b","uri":"/dataFlows/steps/e05fb503-d516-4f2a-974a-f596ea04f29b","type":"application/vnd.sas.transfer.object","responseType":"application/vnd.sas.summary"}],"metadataVersion":1,"version":2,"type":"code","flowMetadata":{},"ui":"{\n\t\"showPageContentOnly\": true,\n\t\"pages\": [\n\t\t{\n\t\t\t\"id\": \"pageOptions\",\n\t\t\t\"type\": \"page\",\n\t\t\t\"label\": \"Options\",\n\t\t\t\"children\": [\n\t\t\t\t{\n\t\t\t\t\t\"id\": \"_sda_explainer_txt\",\n\t\t\t\t\t\"type\": \"text\",\n\t\t\t\t\t\"text\": \"SAS Studio Custom Step for executing the SAS Document Analysis report creation process. At a minimum, users must specify the report type to be output, the file format of the report, and the SAS Launcher Context ID to execute against.\\n\\nFor more details, please reference the link to the official documentation in the about page of this step.\",\n\t\t\t\t\t\"visible\": \"\"\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"id\": \"_sda_command\",\n\t\t\t\t\t\"type\": \"dropdown\",\n\t\t\t\t\t\"label\": \"Select report type:\",\n\t\t\t\t\t\"items\": [\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\"value\": \"create_batch_summary_report.py\",\n\t\t\t\t\t\t\t\"label\": \"Batch Summary\"\n\t\t\t\t\t\t},\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\"value\": \"create_batch_transactions_report.py\",\n\t\t\t\t\t\t\t\"label\": \"Batch Transactions\"\n\t\t\t\t\t\t},\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\"value\": \"create_file_summary_report.py\",\n\t\t\t\t\t\t\t\"label\": \"File Summary\"\n\t\t\t\t\t\t},\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\"value\": \"create_file_transactions_report.py\",\n\t\t\t\t\t\t\t\"label\": \"File Transactions\"\n\t\t\t\t\t\t}\n\t\t\t\t\t],\n\t\t\t\t\t\"required\": true,\n\t\t\t\t\t\"placeholder\": \"\",\n\t\t\t\t\t\"visible\": \"\"\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"id\": \"_sda_report_output_format\",\n\t\t\t\t\t\"type\": \"dropdown\",\n\t\t\t\t\t\"label\": \"Select report output format:\",\n\t\t\t\t\t\"items\": [\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\"value\": \"xlsx\",\n\t\t\t\t\t\t\t\"label\": \"Excel (XLSX)\"\n\t\t\t\t\t\t},\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\"value\": \"csv\",\n\t\t\t\t\t\t\t\"label\": \"CSV\"\n\t\t\t\t\t\t},\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\"value\": \"html\",\n\t\t\t\t\t\t\t\"label\": \"HTML\"\n\t\t\t\t\t\t}\n\t\t\t\t\t],\n\t\t\t\t\t\"required\": true,\n\t\t\t\t\t\"placeholder\": \"\",\n\t\t\t\t\t\"visible\": \"\"\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"id\": \"_sda_launcher_context_name\",\n\t\t\t\t\t\"type\": \"textfield\",\n\t\t\t\t\t\"label\": \"Enter the SAS launcher context name:\",\n\t\t\t\t\t\"placeholder\": \"ex. SAS Document Analysis Runtime\",\n\t\t\t\t\t\"required\": true,\n\t\t\t\t\t\"visible\": \"\"\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"id\": \"_sda_report_filters_section\",\n\t\t\t\t\t\"type\": \"section\",\n\t\t\t\t\t\"label\": \"Optional settings and report filters\",\n\t\t\t\t\t\"open\": false,\n\t\t\t\t\t\"visible\": \"\",\n\t\t\t\t\t\"children\": [\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\"id\": \"_sda_bypass_ssl_security\",\n\t\t\t\t\t\t\t\"type\": \"checkbox\",\n\t\t\t\t\t\t\t\"label\": \"Bypass SSL security check\",\n\t\t\t\t\t\t\t\"visible\": \"\"\n\t\t\t\t\t\t},\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\"id\": \"_sda_wait_for_completion\",\n\t\t\t\t\t\t\t\"type\": \"checkbox\",\n\t\t\t\t\t\t\t\"label\": \"Wait for batch execution before terminating (synchronous processing)\",\n\t\t\t\t\t\t\t\"visible\": \"\"\n\t\t\t\t\t\t},\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\"id\": \"_sda_report_batch_sk_list\",\n\t\t\t\t\t\t\t\"type\": \"textfield\",\n\t\t\t\t\t\t\t\"label\": \"Enter batch SK filter (provide as a comma-separated list):\",\n\t\t\t\t\t\t\t\"placeholder\": \"ex. 1, 2, 3\",\n\t\t\t\t\t\t\t\"required\": false,\n\t\t\t\t\t\t\t\"visible\": \"\",\n\t\t\t\t\t\t\t\"indent\": 0\n\t\t\t\t\t\t},\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\"id\": \"_sda_report_batch_tag_list\",\n\t\t\t\t\t\t\t\"type\": \"textfield\",\n\t\t\t\t\t\t\t\"label\": \"Enter batch tag filter (provide as comma-separated list):\",\n\t\t\t\t\t\t\t\"placeholder\": \"ex. Batch_123, Batch_ABC\",\n\t\t\t\t\t\t\t\"required\": false,\n\t\t\t\t\t\t\t\"visible\": \"\",\n\t\t\t\t\t\t\t\"indent\": 0\n\t\t\t\t\t\t},\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\"id\": \"_sda_report_min_dt\",\n\t\t\t\t\t\t\t\"type\": \"datetime\",\n\t\t\t\t\t\t\t\"label\": \"Select the earliest execution date:\",\n\t\t\t\t\t\t\t\"required\": false,\n\t\t\t\t\t\t\t\"visible\": \"\",\n\t\t\t\t\t\t\t\"indent\": 0\n\t\t\t\t\t\t},\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\"id\": \"_sda_report_max_dt\",\n\t\t\t\t\t\t\t\"type\": \"datetime\",\n\t\t\t\t\t\t\t\"label\": \"Select the latest execution date:\",\n\t\t\t\t\t\t\t\"required\": false,\n\t\t\t\t\t\t\t\"visible\": \"\",\n\t\t\t\t\t\t\t\"indent\": 0\n\t\t\t\t\t\t},\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\"id\": \"_sda_report_include_header\",\n\t\t\t\t\t\t\t\"type\": \"checkbox\",\n\t\t\t\t\t\t\t\"label\": \"Include report header? (Show filter criteria in output)\",\n\t\t\t\t\t\t\t\"visible\": \"\"\n\t\t\t\t\t\t}\n\t\t\t\t\t]\n\t\t\t\t}\n\t\t\t]\n\t\t},\n\t\t{\n\t\t\t\"id\": \"pageAbout\",\n\t\t\t\"type\": \"page\",\n\t\t\t\"label\": \"About\",\n\t\t\t\"children\": [\n\t\t\t\t{\n\t\t\t\t\t\"id\": \"textAbout\",\n\t\t\t\t\t\"type\": \"text\",\n\t\t\t\t\t\"text\": \"OCR - Document Analysis - Produce Usage Report Output step\\n==========\\n\\nThe \\\"OCR - Document Analysis - Produce Usage Report Output\\\" custom steps enables an easy integration with the SAS Document Analysis (SDA) model, to create output reports on executed runs.\\n\\nThe location of the generated output will be displayed for after running this step.\\n\\nThis step can be run after you executed a batch OCR process, for example by using the OCR - Document Analysis - Execute Batch OCR Process custom step.\\n\",\n\t\t\t\t\t\"visible\": \"\"\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"id\": \"sectionPrereqs\",\n\t\t\t\t\t\"type\": \"section\",\n\t\t\t\t\t\"label\": \"Pre-requisites\",\n\t\t\t\t\t\"open\": false,\n\t\t\t\t\t\"visible\": \"\",\n\t\t\t\t\t\"indent\": 0,\n\t\t\t\t\t\"children\": [\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\"id\": \"textPrereqs\",\n\t\t\t\t\t\t\t\"type\": \"text\",\n\t\t\t\t\t\t\t\"text\": \"A license for SAS Document Analysis (SDA) is required and you will need to know the name of the launcher context that was created during the deployment of SDA.\\n\\nPre-requisites:  Tested on Viya version Stable 2024.08 & Stable 2026.01\",\n\t\t\t\t\t\t\t\"visible\": \"\"\n\t\t\t\t\t\t}\n\t\t\t\t\t]\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"id\": \"sectionDocumentation\",\n\t\t\t\t\t\"type\": \"section\",\n\t\t\t\t\t\"label\": \"Documentation\",\n\t\t\t\t\t\"open\": false,\n\t\t\t\t\t\"visible\": \"\",\n\t\t\t\t\t\"children\": [\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\"id\": \"textDocumentation\",\n\t\t\t\t\t\t\t\"type\": \"text\",\n\t\t\t\t\t\t\t\"text\": \"* SAS Document Analysis documentation (https://go.documentation.sas.com/doc/en/aaimdacdc/default/aaimdawlcm/home.htm)\",\n\t\t\t\t\t\t\t\"visible\": \"\"\n\t\t\t\t\t\t}\n\t\t\t\t\t]\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"id\": \"sectionChangelog\",\n\t\t\t\t\t\"type\": \"section\",\n\t\t\t\t\t\"label\": \"Changelog\",\n\t\t\t\t\t\"open\": true,\n\t\t\t\t\t\"visible\": \"\",\n\t\t\t\t\t\"children\": [\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\"id\": \"textChangelog\",\n\t\t\t\t\t\t\t\"type\": \"text\",\n\t\t\t\t\t\t\t\"text\": \"* Version 1.3 (19FEB2026)\\n     - Use absolute path for python command\\n\\n* Version 1.2 (25FEB2025)\\n - Use launcher context name instead ID\\n\\n* Version 1.1 (29OCT2024)\\n     - Implemented feedback\\n\\n* Version: 1.0 (07OCT2024)\\n      - Initial version\",\n\t\t\t\t\t\t\t\"visible\": \"\"\n\t\t\t\t\t\t}\n\t\t\t\t\t]\n\t\t\t\t}\n\t\t\t]\n\t\t}\n\t],\n\t\"syntaxversion\": \"1.3.0\",\n\t\"values\": {\n\t\t\"_sda_command\": null,\n\t\t\"_sda_report_output_format\": {\n\t\t\t\"value\": \"xlsx\",\n\t\t\t\"label\": \"Excel (XLSX)\"\n\t\t},\n\t\t\"_sda_launcher_context_name\": \"SAS Document Analysis Runtime\",\n\t\t\"_sda_bypass_ssl_security\": false,\n\t\t\"_sda_wait_for_completion\": true,\n\t\t\"_sda_report_batch_sk_list\": null,\n\t\t\"_sda_report_batch_tag_list\": \"\",\n\t\t\"_sda_report_min_dt\": null,\n\t\t\"_sda_report_max_dt\": null,\n\t\t\"_sda_report_include_header\": false\n\t}\n}","localUi":"{\"pages\":[{\"children\":[{\"id\":\"_sda_explainer_txt\",\"text\":\"SAS Studio Custom Step for executing the SAS Document Analysis report creation process. At a minimum, users must specify the report type to be output, the file format of the report, and the SAS Launcher Context ID to execute against.\\n\\nFor more details, please reference the link to the official documentation in the about page of this step.\",\"type\":\"text\",\"visible\":\"\"},{\"id\":\"_sda_command\",\"items\":[{\"label\":\"Batch Summary\",\"value\":\"create_batch_summary_report.py\"},{\"label\":\"Batch Transactions\",\"value\":\"create_batch_transactions_report.py\"},{\"label\":\"File Summary\",\"value\":\"create_file_summary_report.py\"},{\"label\":\"File Transactions\",\"value\":\"create_file_transactions_report.py\"}],\"label\":\"Select report type:\",\"placeholder\":\"\",\"required\":true,\"type\":\"dropdown\",\"visible\":\"\"},{\"id\":\"_sda_report_output_format\",\"items\":[{\"label\":\"Excel (XLSX)\",\"value\":\"xlsx\"},{\"label\":\"CSV\",\"value\":\"csv\"},{\"label\":\"HTML\",\"value\":\"html\"}],\"label\":\"Select report output format:\",\"placeholder\":\"\",\"required\":true,\"type\":\"dropdown\",\"visible\":\"\"},{\"id\":\"_sda_launcher_context_name\",\"label\":\"Enter the SAS launcher context name:\",\"placeholder\":\"ex. SAS Document Analysis Runtime\",\"required\":true,\"type\":\"textfield\",\"visible\":\"\"},{\"children\":[{\"id\":\"_sda_bypass_ssl_security\",\"label\":\"Bypass SSL security check\",\"type\":\"checkbox\",\"visible\":\"\"},{\"id\":\"_sda_wait_for_completion\",\"label\":\"Wait for batch execution before terminating (synchronous processing)\",\"type\":\"checkbox\",\"visible\":\"\"},{\"id\":\"_sda_report_batch_sk_list\",\"indent\":0,\"label\":\"Enter batch SK filter (provide as a comma-separated list):\",\"placeholder\":\"ex. 1, 2, 3\",\"required\":false,\"type\":\"textfield\",\"visible\":\"\"},{\"id\":\"_sda_report_batch_tag_list\",\"indent\":0,\"label\":\"Enter batch tag filter (provide as comma-separated list):\",\"placeholder\":\"ex. Batch_123, Batch_ABC\",\"required\":false,\"type\":\"textfield\",\"visible\":\"\"},{\"id\":\"_sda_report_min_dt\",\"indent\":0,\"label\":\"Select the earliest execution date:\",\"required\":false,\"type\":\"datetime\",\"visible\":\"\"},{\"id\":\"_sda_report_max_dt\",\"indent\":0,\"label\":\"Select the latest execution date:\",\"required\":false,\"type\":\"datetime\",\"visible\":\"\"},{\"id\":\"_sda_report_include_header\",\"label\":\"Include report header? (Show filter criteria in output)\",\"type\":\"checkbox\",\"visible\":\"\"}],\"id\":\"_sda_report_filters_section\",\"label\":\"Optional settings and report filters\",\"open\":false,\"type\":\"section\",\"visible\":\"\"}],\"id\":\"pageOptions\",\"label\":\"Options\",\"type\":\"page\"},{\"children\":[{\"id\":\"textAbout\",\"text\":\"OCR - Document Analysis - Produce Usage Report Output step\\n==========\\n\\nThe \\\"OCR - Document Analysis - Produce Usage Report Output\\\" custom steps enables an easy integration with the SAS Document Analysis (SDA) model, to create output reports on executed runs.\\n\\nThe location of the generated output will be displayed for after running this step.\\n\\nThis step can be run after you executed a batch OCR process, for example by using the OCR - Document Analysis - Execute Batch OCR Process custom step.\\n\",\"type\":\"text\",\"visible\":\"\"},{\"children\":[{\"id\":\"textPrereqs\",\"text\":\"A license for SAS Document Analysis (SDA) is required and you will need to know the name of the launcher context that was created during the deployment of SDA.\\n\\nPre-requisites:  Tested on Viya version Stable 2024.08 \\u0026 Stable 2026.01\",\"type\":\"text\",\"visible\":\"\"}],\"id\":\"sectionPrereqs\",\"indent\":0,\"label\":\"Pre-requisites\",\"open\":false,\"type\":\"section\",\"visible\":\"\"},{\"children\":[{\"id\":\"textDocumentation\",\"text\":\"* SAS Document Analysis documentation (https://go.documentation.sas.com/doc/en/aaimdacdc/default/aaimdawlcm/home.htm)\",\"type\":\"text\",\"visible\":\"\"}],\"id\":\"sectionDocumentation\",\"label\":\"Documentation\",\"open\":false,\"type\":\"section\",\"visible\":\"\"},{\"children\":[{\"id\":\"textChangelog\",\"text\":\"* Version 1.3 (19FEB2026)\\n     - Use absolute path for python command\\n\\n* Version 1.2 (25FEB2025)\\n - Use launcher context name instead ID\\n\\n* Version 1.1 (29OCT2024)\\n     - Implemented feedback\\n\\n* Version: 1.0 (07OCT2024)\\n      - Initial version\",\"type\":\"text\",\"visible\":\"\"}],\"id\":\"sectionChangelog\",\"label\":\"Changelog\",\"open\":true,\"type\":\"section\",\"visible\":\"\"}],\"id\":\"pageAbout\",\"label\":\"About\",\"type\":\"page\"}],\"showPageContentOnly\":true,\"syntaxversion\":\"1.3.0\",\"values\":{\"_sda_bypass_ssl_security\":false,\"_sda_command\":null,\"_sda_launcher_context_name\":\"SAS Document Analysis Runtime\",\"_sda_report_batch_sk_list\":null,\"_sda_report_batch_tag_list\":\"\",\"_sda_report_include_header\":false,\"_sda_report_max_dt\":null,\"_sda_report_min_dt\":null,\"_sda_report_output_format\":{\"label\":\"Excel (XLSX)\",\"value\":\"xlsx\"},\"_sda_wait_for_completion\":true}}","templates":{"SAS":"* _sda_ is short for SAS Document Analysis;\ndata _null_;\n/*Clean up whitespace around delimited list entries*/\n%let _sda_report_batch_tag_list = %sysfunc(compbl(%quote(&_sda_report_batch_tag_list.)));\n%let _sda_report_batch_tag_list = %sysfunc(tranwrd(%quote(&_sda_report_batch_tag_list.), %str(, ), %str(,)));\n%let _sda_report_batch_tag_list = %sysfunc(tranwrd(%quote(&_sda_report_batch_tag_list.), %str( ,), %str(,)));\n\n%let _sda_report_batch_sk_list = %sysfunc(compbl(%quote(&_sda_report_batch_sk_list.)));\n%let _sda_report_batch_sk_list = %sysfunc(tranwrd(%quote(&_sda_report_batch_sk_list.), %str(, ), %str(,)));\n%let _sda_report_batch_sk_list = %sysfunc(tranwrd(%quote(&_sda_report_batch_sk_list.), %str( ,), %str(,)));\n\n* Get the Viya Host URL;\n%let _sda_viya_host=%sysfunc(getoption(SERVICESBASEURL));\n\n%let _sda_context_name_encoded=%sysfunc(urlencode(&_sda_launcher_context_name.));\n\nfilename _sda_out temp; \n\n/*Proc HTTP Request*/\nproc http method='GET' \n    url=%tslit(&_sda_viya_host./launcher/contexts?filter=eq(name,\"&_sda_context_name_encoded.\"))\n    oauth_bearer=sas_services out=_sda_out; \n    headers 'Accept'=' application/json'; \n    headers 'Content-Type'=' application/json';\n    %if &_sda_bypass_ssl_security. %then %do;\n        SSLPARMS \"SSLREQCERT\" = \"ALLOW\";\n    %end;\t\t\nrun;\n\n%if %symexist(SYS_PROCHTTP_STATUS_CODE) %then %do;\n\t* HTTP Status Handling;\n\tdata _null_; \n\t    if &SYS_PROCHTTP_STATUS_CODE. lt 400 then do; \n\t        putLog 'NOTE: The request to retrieve the launcher context ID was successful.'; \n\t        putLog \"NOTE: The HTTP Status Code is &SYS_PROCHTTP_STATUS_CODE..\"; \n\t        putLog \"NOTE: That means: &SYS_PROCHTTP_STATUS_PHRASE..\"; \n\t    end; \n\t    else do; \n\t        putLog 'ERROR: The request to retrieve the launcher context ID was most likely not successful.'; \n\t        putLog \"ERROR: The HTTP Status Code is &SYS_PROCHTTP_STATUS_CODE..\"; \n\t        putLog \"ERROR: That means: &SYS_PROCHTTP_STATUS_PHRASE..\"; \n\t\t\tabort 42;\n\t    end; \n\trun;\n%end;\n%else %do;\n\t* HTTP Status Handling - response code not logged to macrovar;\n\tdata _null_; \n\t        putLog 'ERROR: The request to retrieve the launcher context ID was most likely not successful.'; \n\t        putLog \"ERROR: The HTTP Status Code is unknown.\"; \n\t\t\tabort 42;\n\trun;\n%end;\n\nlibname GET json fileref=_sda_out;\n\n/*Load SDA Context ID to macrovar*/\ndata _null_;\n\tset GET.ITEMS;\n\tcall symputx(\"_sda_launcher_context_id\", strip(id));\nrun;\n\nfilename _sda_out clear;\n\n%if \"&_sda_launcher_context_id\"=\".\" or \"&_sda_launcher_context_id\" =\"\" %then %do;\n\t* HTTP Status Handling - response code not logged to macrovar;\n\tdata _null_; \n\t        putLog \"ERROR: ID not found for launcher context: &_sda_launcher_context_name\";\n            putLog \"ERROR: Please check that the launcher context is properly configured.\"; \n\t\t\tabort 42;\n\trun;\n%end;\n\n* Preprocess macrovars to convert binary to boolean;\n%if &_sda_report_include_header. %then %do; %let _sda_report_include_header = True; %end;\n%else %do; %let _sda_report_include_header = False; %end;\n%if &_sda_wait_for_completion. %then %do; %let _sda_wait_for_completion=True; %end;\n%else %do; %let _sda_wait_for_completion = False; %end;\n%if %symexist(_sda_max_wait_time_minutes)=0 %then %do; %let _sda_max_wait_time_minutes = 0; %end;\n\n* Compose http request body message;\n%let _sda_http_request_body=%str({ \"name\":\"sda-produce-usage-report\",\n          \"description\":\"Output SAS Document Analysis Usage Report\",\n           \"command\":\"/usr/local/bin/python process/sda-ocr/scripts/%superq(_sda_command)\",\n           \"contextId\":\"%superq(_sda_launcher_context_id)\",\n           \"environment\":{\n                \"REPORT_OUTPUT_FORMAT\":\"%superq(_sda_report_output_format)\",\n                \"REPORT_INCLUDE_HEADER\":\"%superq(_sda_report_include_header)\",\n                \"REPORT_BATCH_SK_LIST\":\"%superq(_sda_report_batch_sk_list)\",\n                \"REPORT_BATCH_TAG_LIST\":\"%superq(_sda_report_batch_tag_list)\",\n                \"REPORT_MIN_DT\":\"%superq(_sda_report_min_dt)\",\n                \"REPORT_MAX_DT\":\"%superq(_sda_report_max_dt)\"\n            }, \n           \"kubernetes\": {\"jobNamePrefix\": \"sda-execute-report-\"} \n     });\n\nfilename _sda_out temp; \n\n* Proc HTTP Request;\nproc http method='Post' \n    url=\"&_sda_viya_host./launcher/processes\" \n    in=%tslit(&_SDA_HTTP_REQUEST_BODY)\n    oauth_bearer=sas_services\n    out=_sda_out; \n    headers 'Accept'='application/vnd.sas.launcher.process+json'; \n    headers 'Content-Type'='application/json';\n    %if &_sda_bypass_ssl_security. %then %do;\n        SSLPARMS \"SSLREQCERT\" = \"ALLOW\";\n    %end;\t\nrun; quit;\n\n%if %symexist(SYS_PROCHTTP_STATUS_CODE) %then %do;\n\t* HTTP Status Handling;\n\tdata _null_; \n\t    if &SYS_PROCHTTP_STATUS_CODE. lt 400 then do; \n\t        putLog 'NOTE: The request to launch the SDA process was successful.'; \n\t        putLog \"NOTE: The HTTP Status Code is &SYS_PROCHTTP_STATUS_CODE..\"; \n\t        putLog \"NOTE: That means: &SYS_PROCHTTP_STATUS_PHRASE..\"; \n\t    end; \n\t    else do; \n\t        putLog 'ERROR: The request to launch the SDA process was most likely not successful.'; \n\t        putLog \"ERROR: The HTTP Status Code is &SYS_PROCHTTP_STATUS_CODE..\"; \n\t        putLog \"ERROR: That means: &SYS_PROCHTTP_STATUS_PHRASE..\"; \n\t\t\tabort 42;\n\t    end; \n\trun;\n%end;\n%else %do;\n\t* HTTP Status Handling - response code not logged to macrovar;\n\tdata _null_; \n\t        putLog 'ERROR: The request to launch the SDA process was most likely not successful.'; \n\t        putLog \"ERROR: The HTTP Status Code is unknown.\"; \n\t\t\tabort 42;\n\trun;\n%end;\n\n%let _sda_process = '';\n%let _sda_output_directory = '';\n%let _sda_sas_launcher_process_id = '';\n\n%if %sysfunc(fexist(_sda_out)) %then %do;\n\tlibname _sda_out json;\n\t* Check if a output directory that differs from the default was provided;\n\tdata _null_;\n\t    set _sda_out.alldata;\n\t    if upcase(P1)='ENVIRONMENT' then do;\n\t        if upcase(P2)='OUTPUT_DIRECTORY' then call symput('_sda_output_directory', cats(value));\n\t        if upcase(P2)='PROCESS' then call symput('_sda_process', cats(value));\n\t\t\tif upcase(P2)=\"SAS_LAUNCHER_PROCESS_ID\" then call symputx(\"_sda_sas_launcher_process_id\",cats(value),'g');\n\t    end;\n\trun;\n\n\t* Inform the user about the outcome of the process;\n\tdata work._sda_message_output;\n\t    length sda_launcher_message $500;\n\t    if \"&_sda_output_directory.\" ne '' and \"&_sda_process.\" ne '' then do;\n\t        sda_launcher_message = 'Logs have been routed to ' || \"&_sda_output_directory./&_sda_process./logs\";\n\t        output;\n\t        sda_launcher_message = 'Output data has been routed to ' || \"&_sda_output_directory./&_sda_process./reports\";\n\t        output;\n\t    end;\n\t    else do;\n\t        sda_launcher_message = 'Data and logs have been routed to the default location specified during installation';\n\t        output;\n\t    end;\n\trun;\n\n\t* Print the launcher information for the user;\n\tproc print data=work._sda_message_output noObs label;\n\t    var sda_launcher_message;\n\t\tlabel sda_launcher_message=\"SDA Launcher Message\";\n\tquit;\n\n%end;\n%else %do;\n\tdata _null_; \n\t        put 'ERROR: The PROC HTTP response JSON could not be found.';\n\t\t\tabort 42;\n\trun;\n%end;\n\n%global _sda_elapsed_time;\n\n%macro _sda_check_process_status(_sda_start_time=0);\n    %if &_sda_start_time = 0 %then %let _sda_start_time = %sysfunc(datetime());\n    %let _sda_current_time = %sysfunc(datetime());\n    %let _sda_elapsed_time = %sysfunc(round(%sysevalf((&_sda_current_time - &_sda_start_time)/60), 0.01)); /* Convert seconds to minutes */\n\n    filename _sda_out clear;\n    filename _sda_out temp;\n\n    proc http\n        method='get'\n        url=\"&_sda_viya_host./launcher/processes/&_sda_sas_launcher_process_id./state\"\n        oauth_bearer = sas_services\n        out=_sda_out;\n        headers 'Accept' = 'text/plain';\n    quit;\n\n\tdata _null_;\n\t\tcall sleep(5, 1);\n\trun;\n\n\t%if %sysfunc(fexist(_sda_out)) %then %do;\n\t\t%if %symexist(SYS_PROCHTTP_STATUS_CODE) %then %do;\n\t\t    data _null_;\n\t\t        length status $128.;\n\t\t        infile _sda_out;\n\t\t        input status $;\n\t\t        if &SYS_PROCHTTP_STATUS_CODE. lt 400 then do;\n\t\t            if status = 'completed' then do;\n\t\t                putLog \"NOTE: SDA process completed successfully.\";\n\t\t            end;\n\t\t            else if status = 'failed' then do;\n\t\t                putLog \"ERROR: SDA process did not complete successfully. Please see SDA batch logs for more information.\";\n\t\t\t\t\t\tabort 42;\n\t\t            end;\n\t\t            else if %sysevalf(&_sda_elapsed_time >= &_sda_max_wait_time_minutes) and %sysevalf(&_sda_max_wait_time_minutes > 0) then do;\n\t\t                putLog \"WARNING: Maximum wait time of &_sda_max_wait_time_minutes minutes reached. Last known process status = \" status;\n\t\t            end;\n\t\t            else do;\n\t\t                * Wait for 5 seconds before making another call;\n\t\t                *putLog \"NOTE: Process status = \" status\". Waiting for process to finish.\";\n\t\t                call sleep(5, 1);\n\t\t                call execute('%_sda_check_process_status(_sda_start_time=&_sda_start_time)');\n\t\t            end;\n\t\t        end;\n\t\t        else do;\n\t\t            putLog \"ERROR: The request to check the status of the SDA process was not successful.\"; \n\t\t            putLog \"ERROR: The HTTP Status Code is &SYS_PROCHTTP_STATUS_CODE..\"; \n\t\t            putLog \"ERROR: That means: &SYS_PROCHTTP_STATUS_PHRASE..\"; \n\t\t\t\t\tabort 42;\n\t\t        end; \n\t\t    run;\n\t\t%end;\n\t\t%else %do;\n\t\t\t* HTTP Status Handling - response code not logged to macrovar;\n\t\t\tdata _null_; \n\t\t            putLog \"ERROR: The request to check the status of the SDA process was not successful.\"; \n\t\t\t        putLog \"ERROR: The HTTP Status Code is unknown.\"; \n\t\t\t\t\tabort 42;\n\t\t\trun;\n\t\t%end;\n\t%end;\n\t%else %do;\n\t\tdata _null_; \n\t\t        putLog 'ERROR: The PROC HTTP response JSON could not be found.';\n\t\t\t\tabort 42;\n\t\trun;\n\t%end;\n%mend _sda_check_process_status;\n\n%if %str(&_sda_wait_for_completion.) = %str(True) %then %do;\n    %_sda_check_process_status();\n%end;\n\n%put _sda_wait_for_completion IS &_sda_wait_for_completion;\n\n* Inform the user about the outcome of the process;\ndata work._sda_message_output;\n    length sda_process_message $500;\n\tif \"&_sda_wait_for_completion.\" = \"True\" then do;\n        sda_process_message = cat(\"Process executed synchronously in \",\"&_sda_elapsed_time.\",\" minutes\");\n        output;\n\tend;\n\telse do;\n        sda_process_message = 'Process executed asynchronously. Process may still be running in the background';\n        output;\n\tend;\nrun;\n\n* Print the process information for the user;\nproc print data=work._sda_message_output noObs label;\n    var sda_process_message;\n\tlabel sda_process_message=\"SDA Process Message\";\nquit;\n\n* Clean up;\nlibname _sda_out clear;\nfilename _sda_out clear;\n%symdel _sda_viya_host _sda_http_request_body _sda_process _sda_sas_launcher_process_id\n\t\t_sda_report_batch_sk_list _sda_report_batch_tag_list\n\t\t_sda_wait_for_completion _sda_elapsed_time;\nproc datasets library=work noList;\n    delete _sda_message_output;\nrun; quit;"}}
